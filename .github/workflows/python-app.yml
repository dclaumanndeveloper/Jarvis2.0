name: Build Windows Installer

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build .exe with PyInstaller
        run: |
          pyinstaller --onefile main.py

      - name: Download Inno Setup
        run: |
          curl -L -o innosetup.exe https://jrsoftware.org/download.php/is.exe
          Start-Process -Wait -FilePath ".\innosetup.exe" -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-"

      - name: Download NSSM
        run: |
          curl -L -o nssm.zip https://nssm.cc/release/nssm-2.24.zip
          tar -xf nssm.zip

      - name: Prepare Inno Setup script
        run: |
          echo [Setup] > installer.iss
          echo AppName=Jarvis >> installer.iss
          echo AppVersion=1.0 >> installer.iss
          echo DefaultDirName="{pf}\\Jarvis" >> installer.iss
          echo [Files] >> installer.iss
          echo "Source: \"dist\\main.exe\"; DestDir: \"{app}\"; Flags: ignoreversion" >> installer.iss
          echo "Source: \"nssm-2.24\\win64\\nssm.exe\"; DestDir: \"{app}\"; Flags: ignoreversion" >> installer.iss
          echo [Run] >> installer.iss
          echo Filename: "{app}\\nssm.exe"; Parameters: "install Jarvis \"{app}\\main.exe\""; Flags: runhidden >> installer.iss

      - name: Build Windows Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer.iss"

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: Output/*.exe
